!function(t){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","jquery-ui/resizable","jQuery.print"],t):"object"==typeof exports?t(require("jquery","underscore","backbone","jquery-ui/resizable","jQuery.print")):t(jQuery,_,Backbone)}(function(t,e,i){function s(t){return t*h}function n(t){return t*o}function r(t){return t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()}function a(t){for(var e=[g,d,c,p],i=0;i<e.length;i++)t(e[i])}var h=3.779528,o=.264583,d="right",g="left",c="top",p="bottom",u={left:"width",right:"width",top:"height",bottom:"height"},l={left:"right",right:"left",bottom:"top",top:"bottom"},m=i.Model.extend({initialize:function(i){var n=this
this.items=[],a(function(t){n.on("change:"+t+"Border",function(e,i){if(e!=n&&(i=e),i){n.updateBorderValue(t,i),(t==g||t==c)&&n.view.$items.css(t,s(i))
var a=n.get("page"+r(u[t]))-n.get(l[t]+"Border")-i
n.view.$items[u[t]](s(a))}})}),this.on("change:pageHeight",function(t,e){if(t!=n&&(e=t),e){this.view.$page.height(s(e)),n.view.rules.left.css("line-height",s(e)+"px"),n.view.rules.right.css("line-height",s(e)+"px")
var i=this.get("topBorder")
this.unset("topBorder").set("topBorder",i),this.view.setParam("pageHeight",e)}}),this.on("change:pageWidth",function(t,e){t!=n&&(e=t),this.view.$page.width(s(e))
var i=this.get("rightBorder")
this.unset("rightBorder").set("rightBorder",i),this.view.setParam("pageWidth",e)}),this.on("change:itemsCount",function(t,e){if(t!=n&&(e=t),!(0>e)){var i=this.previous("itemsCount")||0
if(e>i)for(var s=0;e-i>s;s++)n.addItem()
else for(var r=0;i-e>r;r++)n.popItem()
this.view.setParam("itemsCount",e)}}),this.on("change:fontSize",function(e,i){var s=t("<span>").html("1").css({fontSize:i,fontFamily:"Courier, monospace"})
t("body").append(s),this.set("charWidth",s.width()),s.remove()}),this.on("destroy",function(){this.view.remove()}),e.each(["fontSize","imageWidth","itemWidth","itemHeight","text"],function(t){n.on("change:"+t,function(){n.view.setParam(t,n.get(t)),n.updateItems()})}),this.view=new v({model:this,el:t(this.get("selector"))}),this.view.render(),this.clear().set(i)},updateItems:function(){for(var t=0;t<this.items.length;t++)this.items[t].setStyle(this.getItemStyle())},getItemStyle:function(){return{fontSize:this.get("fontSize"),width:this.get("itemWidth"),height:this.get("itemHeight"),imageWidth:this.get("imageWidth"),charWidth:this.get("charWidth"),text:this.get("text")}},updateBorderValue:function(t,e){this.view.rules[t].css(t,s(e)).html("<span>"+parseInt(e)+"</span>"),this.view.setParam(t+"Border",e)},addItem:function(t){t=t||{}
var i={},s=this.get("barcodeImage")
s&&(i.src=t.src||s)
var n=new f(i)
return n.render(),n.setStyle(e.extend(this.getItemStyle(),t)),this.view.$items.append(n.$el),this.items.push(n),n},popItem:function(){this.items[this.items.length-1].remove(),this.items.pop()},countInPage:function(){var t=Math.floor(this.get("pageWidth")/this.get("itemWidth")),e=Math.floor(this.get("pageHeight")/this.get("itemHeight"))
return t*e}}),f=i.View.extend({className:"item",template:'<div class="wrap">                <div class="cell">                    <p></p>                    <img>                </div>            </div>',initialize:function(t){this.options=t},render:function(){this.$el.html(e.template(this.template)())
var t=this
this.$el.find("img").attr("src",this.options.src||"dist/barcode.png").on("load",function(){t.trigger("imageLoaded")})},setStyle:function(t){var e=s(t.width)
this.$el.css({width:e,height:s(t.height)}),this.$el.find("p").css({fontSize:t.fontSize,fontFamily:"Courier, monospace"}).text(this.strMax(t.text,e/(t.charWidth||10))),this.$el.find("img").css("width",s(t.imageWidth))},strMax:function(t,e){return t&&t.length?t.length>e?t.substr(0,e-2)+"..":t:""}}),v=i.View.extend({events:{"click button.print":"print"},initialize:function(){this.$page=this.$(".pageHandler .page"),this.$items=this.$page.children(".items"),this.$rules=this.$page.children(".rule"),this.$params=this.$el.find('.parameters input[type="number"], .parameters input[type="text"]'),this.rules={}
var t=this
a(function(e){t.rules[e]=t.$rules.filter("."+e)})},render:function(){var e=this,i=this.model
this.$items.resizable({handles:"n, e, s, w",containment:"parent",resize:function(t,r){var h=e.$items.position()
h.right=s(i.get("pageWidth"))-(h.left+r.size.width),h.bottom=s(i.get("pageHeight"))-(h.top+r.size.height),a(function(t){i.updateBorderValue(t,n(h[t]))})}}),this.$params.change(function(){var e=t(this),s=e.val()
"number"==e.attr("type")&&(s=parseInt(s)),i.set(e.attr("name"),s)})},print:function(){var e=this.model,i=e.countInPage(),s=e.items.length,n=e.get("pageHeight"),r=t.Deferred()
e.set("pageHeight",Math.ceil(s/i)*n),r.then(function(){e.set("pageHeight",n)}),this.$el.print({deferred:r})},setParam:function(t,e){var i=this.$params.filter('[name="'+t+'"]')
"number"==i.attr("type")&&(e=parseInt(e)),i.val(e)}})
return m.printBarcodes=function(i,s){function n(){a.view.$el.css("position","static"),a.view.print(),a.destroy()}i.itemsCount=0
var r=t('<div class="barcodeEditor"><div class="pageHandler"><div class="page"><div class="items"></div></div></div></div>')
r.css({position:"absolute",left:"-9000px",top:"-9000px"}).attr("id",e.uniqueId("beditor_")),t("body").append(r),i.selector="#"+r.attr("id")
for(var a=new m(i),h=s.length+1-1,o=0;o<s.length;o++){var d=a.addItem(s[o])
d.on("imageLoaded",function(){h--,0>=h&&n()})}},window.BarcodeEditorFactory={Model:m,View:v,ItemView:f},m})
